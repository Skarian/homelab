---
- name: Bootstrap Proxmox for Terraform + IaC
  hosts: proxmox
  gather_facts: false

  pre_tasks:
    - name: Read service account token item from 1Password (local)
      ansible.builtin.command: >
        op item get "{{ op_service_account_item }}" --vault "{{ op_vault }}" --format json
      register: op_service_account_item_get
      changed_when: false
      failed_when: false
      delegate_to: localhost
      run_once: true
      no_log: true

    - name: Set service account token from 1Password item
      ansible.builtin.set_fact:
        op_service_account_token: >-
          {{
            (op_service_account_item_get.stdout | default('{}') | from_json).fields
            | selectattr('label', 'in', ['credential', 'token', 'password'])
            | map(attribute='value')
            | first
            | default('')
            | trim
          }}
      delegate_to: localhost
      delegate_facts: true
      run_once: true
      no_log: true

    - name: Fail if 1Password token is missing
      ansible.builtin.fail:
        msg: >-
          OP_SERVICE_ACCOUNT_TOKEN not found. Unlock 1Password and ensure the item
          "{{ op_service_account_item }}" in vault "{{ op_vault }}" has a field
          labeled "credential", "token", or "password".
      when: hostvars['localhost'].op_service_account_token | length == 0
      delegate_to: localhost
      run_once: true

    - name: Read SSH key item from 1Password (local)
      ansible.builtin.command: >
        op item get "{{ op_ssh_key_item }}" --vault "{{ op_vault }}" --format json
      register: op_ssh_key_item_get
      changed_when: false
      delegate_to: localhost
      run_once: true
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ hostvars['localhost'].op_service_account_token }}"

    - name: Set SSH public key
      ansible.builtin.set_fact:
        ssh_pubkey: >-
          {{
            (op_ssh_key_item_get.stdout | from_json).fields
            | selectattr('label', 'equalto', 'public key')
            | map(attribute='value')
            | first
            | default('')
          | trim
          }}

    - name: Fail if SSH public key is missing
      ansible.builtin.fail:
        msg: "public key not found in 1Password item {{ op_ssh_key_item }}"
      when: ssh_pubkey | length == 0

    - name: Check for python3 (raw)
      ansible.builtin.raw: command -v python3
      register: python3_check
      changed_when: false
      failed_when: false

    - name: Check for sudo (raw)
      ansible.builtin.raw: dpkg -s sudo
      register: sudo_check
      changed_when: false
      failed_when: false

    - name: Update apt cache if needed (raw)
      ansible.builtin.raw: apt-get update -y
      when: python3_check.rc != 0 or sudo_check.rc != 0

    - name: Install python3 if missing (raw; needed for modules)
      ansible.builtin.raw: |
        apt-get install -y python3
      when: python3_check.rc != 0

    - name: Install sudo if missing (raw)
      ansible.builtin.raw: |
        apt-get install -y sudo
      when: sudo_check.rc != 0

    - name: Gather facts now that python exists
      ansible.builtin.setup:

  tasks:
    - name: Ensure terraform linux user exists
      ansible.builtin.user:
        name: "{{ terraform_linux_user }}"
        shell: /bin/bash
        create_home: true

    - name: Ensure SSH key present for terraform user
      ansible.builtin.authorized_key:
        user: "{{ terraform_linux_user }}"
        key: "{{ ssh_pubkey }}"
        state: present

    - name: Ensure snippets directory exists
      ansible.builtin.file:
        path: "{{ snippets_dir }}"
        state: directory
        mode: "0755"

    - name: Install sudoers file (validated)
      ansible.builtin.copy:
        dest: "{{ sudoers_path }}"
        content: "{{ sudoers_content }}"
        owner: root
        group: root
        mode: "0440"
        validate: "visudo -cf %s"

    # --- Proxmox RBAC via pveum ---
    # Purpose: create a least-privilege role for Terraform and bind it to a group/user.
    - name: Check existing roles
      ansible.builtin.command: pveum role list --output-format json
      register: role_list
      changed_when: false

    - name: Determine if role exists
      ansible.builtin.set_fact:
        role_exists: >-
          {{
            (role_list.stdout | from_json
            | selectattr('roleid', 'equalto', pve_role)
            | list
            | length) > 0
          }}

    - name: Create role if missing
      ansible.builtin.command: >
        pveum role add {{ pve_role }} -privs
        "Datastore.Allocate Datastore.AllocateSpace Datastore.AllocateTemplate Datastore.Audit
         Pool.Allocate Sys.Audit Sys.Console Sys.Modify SDN.Use
         VM.Allocate VM.Audit VM.Clone
         VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType
         VM.Config.Memory VM.Config.Network VM.Config.Options
         VM.Migrate VM.Monitor VM.PowerMgmt
         User.Modify"
      when: not role_exists

    - name: Check existing groups
      ansible.builtin.command: pveum group list --output-format json
      register: group_list
      changed_when: false

    - name: Determine if group exists
      ansible.builtin.set_fact:
        group_exists: >-
          {{
            (group_list.stdout | from_json
            | selectattr('groupid', 'equalto', pve_group)
            | list
            | length) > 0
          }}

    - name: Create group if missing
      ansible.builtin.command: pveum group add {{ pve_group }}
      when: not group_exists

    - name: Check ACL list
      ansible.builtin.command: pveum acl list --output-format json
      register: acl_list
      changed_when: false

    - name: Determine if ACL exists
      ansible.builtin.set_fact:
        acl_exists: >-
          {{
            (acl_list.stdout | from_json
            | selectattr('path', 'equalto', '/')
            | selectattr('type', 'equalto', 'group')
            | selectattr('ugid', 'equalto', pve_group)
            | selectattr('roleid', 'equalto', pve_role)
            | list
            | length) > 0
          }}

    - name: Ensure ACL set for group at /
      ansible.builtin.command: pveum acl modify / -group {{ pve_group }} -role {{ pve_role }}
      when: not acl_exists

    - name: Check existing users
      ansible.builtin.command: pveum user list --output-format json
      register: user_list
      changed_when: false

    - name: Determine if user exists
      ansible.builtin.set_fact:
        user_exists: >-
          {{
            (user_list.stdout | from_json
            | selectattr('userid', 'equalto', pve_user)
            | list
            | length) > 0
          }}

    - name: Create user if missing
      ansible.builtin.command: pveum useradd {{ pve_user }} -groups {{ pve_group }}
      when: not user_exists

    - name: Ensure user is in group (if user existed)
      ansible.builtin.command: pveum user modify {{ pve_user }} -groups {{ pve_group }}
      when: user_exists
      changed_when: false

    # --- Token: create if missing, store in 1Password if created ---
    - name: List existing tokens for user
      ansible.builtin.command: pveum user token list {{ pve_user }} --output-format json
      register: token_list
      changed_when: false
      failed_when: false

    - name: Default token_exists to false
      ansible.builtin.set_fact:
        token_exists: false

    - name: Determine if token exists
      ansible.builtin.set_fact:
        token_exists: >-
          {{
            (token_list.stdout | from_json
            | selectattr('tokenid', 'equalto', pve_token_name)
            | list
            | length) > 0
          }}
      when: token_list.rc == 0 and (token_list.stdout | trim) != ""

    - name: Create token if missing (secret printed once)
      ansible.builtin.command: pveum user token add {{ pve_user }} {{ pve_token_name }} -privsep {{ pve_token_privsep }} --output-format json
      register: token_create
      when: not token_exists
      no_log: true

    - name: Build API token value if created
      ansible.builtin.set_fact:
        pve_api_token_value: >-
          {{
            ((token_create.stdout | from_json).tokenid | default(pve_user ~ '!' ~ pve_token_name))
            ~ '='
            ~ ((token_create.stdout | from_json).value | default(''))
          }}
      when: token_create is defined and token_create.changed
      no_log: true

    - name: Set 1Password API item title
      ansible.builtin.set_fact:
        op_api_item_title: "{{ op_item_prefix }}/{{ inventory_hostname }}/{{ op_api_item_suffix }}"

    - name: Fail if pve_endpoint is missing
      ansible.builtin.fail:
        msg: "pve_endpoint is required in host_vars for {{ inventory_hostname }}"
      when: pve_endpoint is not defined or pve_endpoint | length == 0

    - name: Check 1Password API item
      ansible.builtin.command: >
        op item get "{{ op_api_item_title }}" --vault "{{ op_vault }}" --format json
      register: op_api_item_get
      changed_when: false
      failed_when: false
      delegate_to: localhost
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ hostvars['localhost'].op_service_account_token }}"

    - name: Create 1Password API item if missing
      ansible.builtin.shell: |
        set -euo pipefail
        op item template get "Secure Note" --format json | \
          op item create --vault "{{ op_vault }}" --title "{{ op_api_item_title }}" --format json
      when: op_api_item_get.rc != 0
      delegate_to: localhost
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ hostvars['localhost'].op_service_account_token }}"

    - name: Read current endpoint from 1Password
      ansible.builtin.set_fact:
        op_endpoint_current: >-
          {{
            (op_api_item_get.rc == 0)
            | ternary(
                (op_api_item_get.stdout | from_json).fields
                | selectattr('label', 'equalto', 'endpoint')
                | map(attribute='value')
                | first
                | default(''),
                ''
              )
          }}

    - name: Warn if token exists but cannot be stored
      ansible.builtin.debug:
        msg: >-
          1Password item {{ op_api_item_title }} created without a token because
          the Proxmox API token already existed and its secret cannot be re-shown.
          Rotate the token or set the token field manually in 1Password.
      when:
        - op_api_item_get.rc != 0
        - token_create is not defined or not token_create.changed

    - name: Write API token to 1Password if created
      ansible.builtin.shell: |
        set -euo pipefail
        op item get "{{ op_api_item_title }}" --vault "{{ op_vault }}" --format json | \
          python3 -c 'import json, os, sys
        data = json.load(sys.stdin)
        label = os.environ["OP_FIELD_LABEL"]
        value = os.environ["OP_FIELD_VALUE"]
        ftype = os.environ["OP_FIELD_TYPE"]
        fields = data.get("fields", [])
        for f in fields:
          if f.get("label") == label:
            f["value"] = value
            f["type"] = ftype
            break
        else:
          fields.append({"label": label, "type": ftype, "value": value})
        data["fields"] = fields
        json.dump(data, sys.stdout)' | \
          op item edit "{{ op_api_item_title }}" --vault "{{ op_vault }}"
      when: pve_api_token_value is defined and pve_api_token_value | length > 0
      delegate_to: localhost
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ hostvars['localhost'].op_service_account_token }}"
        OP_FIELD_LABEL: "token"
        OP_FIELD_VALUE: "{{ pve_api_token_value }}"
        OP_FIELD_TYPE: "CONCEALED"
      no_log: true

    - name: Ensure endpoint stored in 1Password
      ansible.builtin.shell: |
        set -euo pipefail
        op item get "{{ op_api_item_title }}" --vault "{{ op_vault }}" --format json | \
          python3 -c 'import json, os, sys
        data = json.load(sys.stdin)
        label = os.environ["OP_FIELD_LABEL"]
        value = os.environ["OP_FIELD_VALUE"]
        ftype = os.environ["OP_FIELD_TYPE"]
        fields = data.get("fields", [])
        for f in fields:
          if f.get("label") == label:
            f["value"] = value
            f["type"] = ftype
            break
        else:
          fields.append({"label": label, "type": ftype, "value": value})
        data["fields"] = fields
        json.dump(data, sys.stdout)' | \
          op item edit "{{ op_api_item_title }}" --vault "{{ op_vault }}"
      when: op_endpoint_current != pve_endpoint
      delegate_to: localhost
      environment:
        OP_SERVICE_ACCOUNT_TOKEN: "{{ hostvars['localhost'].op_service_account_token }}"
        OP_FIELD_LABEL: "endpoint"
        OP_FIELD_VALUE: "{{ pve_endpoint }}"
        OP_FIELD_TYPE: "STRING"
      no_log: true

    - name: Report token status
      ansible.builtin.debug:
        msg: >-
          {{
            (token_create is defined and token_create.changed)
            | ternary(
                'Token CREATED and saved to 1Password item ' ~ op_api_item_title ~ '.',
                'Token already exists for ' ~ pve_user ~ '!' ~ pve_token_name ~ ' (secret cannot be re-shown). Rotate by deleting token then rerun.'
              )
          }}
