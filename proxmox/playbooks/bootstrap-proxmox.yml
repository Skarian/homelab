---
- name: Bootstrap Proxmox for Terraform + IaC
  hosts: proxmox
  gather_facts: false

  pre_tasks:
    - name: Read SSH pubkey from controller
      ansible.builtin.set_fact:
        ssh_pubkey: "{{ lookup('file', ssh_pubkey_file) }}"
      delegate_to: localhost
      run_once: true

    - name: Check for python3 (raw)
      ansible.builtin.raw: command -v python3
      register: python3_check
      changed_when: false
      failed_when: false

    - name: Check for sudo (raw)
      ansible.builtin.raw: dpkg -s sudo
      register: sudo_check
      changed_when: false
      failed_when: false

    - name: Update apt cache if needed (raw)
      ansible.builtin.raw: apt-get update -y
      when: python3_check.rc != 0 or sudo_check.rc != 0

    - name: Install python3 if missing (raw; needed for modules)
      ansible.builtin.raw: |
        apt-get install -y python3
      when: python3_check.rc != 0

    - name: Install sudo if missing (raw)
      ansible.builtin.raw: |
        apt-get install -y sudo
      when: sudo_check.rc != 0

    - name: Gather facts now that python exists
      ansible.builtin.setup:

  tasks:
    - name: Ensure terraform linux user exists
      ansible.builtin.user:
        name: "{{ terraform_linux_user }}"
        shell: /bin/bash
        create_home: true
        groups: sudo
        append: true

    - name: Ensure SSH key present for terraform user
      ansible.builtin.authorized_key:
        user: "{{ terraform_linux_user }}"
        key: "{{ ssh_pubkey }}"
        state: present

    - name: Ensure snippets directory exists
      ansible.builtin.file:
        path: "{{ snippets_dir }}"
        state: directory
        mode: "0755"

    - name: Install sudoers file (validated)
      ansible.builtin.copy:
        dest: "{{ sudoers_path }}"
        content: "{{ sudoers_content }}"
        owner: root
        group: root
        mode: "0440"
        validate: "visudo -cf %s"

    # --- Proxmox RBAC via pveum ---
    # Purpose: create a least-privilege role for Terraform and bind it to a group/user.
    - name: Check existing roles
      ansible.builtin.command: pveum role list --output-format json
      register: role_list
      changed_when: false

    - name: Determine if role exists
      ansible.builtin.set_fact:
        role_exists: >-
          {{
            (role_list.stdout | from_json
            | selectattr('roleid', 'equalto', pve_role)
            | list
            | length) > 0
          }}

    - name: Create role if missing
      ansible.builtin.command: >
        pveum role add {{ pve_role }} -privs
        "Datastore.Allocate Datastore.AllocateSpace Datastore.AllocateTemplate Datastore.Audit
         Pool.Allocate Sys.Audit Sys.Console Sys.Modify SDN.Use
         VM.Allocate VM.Audit VM.Clone
         VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType
         VM.Config.Memory VM.Config.Network VM.Config.Options
         VM.Migrate VM.Monitor VM.PowerMgmt
         User.Modify"
      when: not role_exists

    - name: Check existing groups
      ansible.builtin.command: pveum group list --output-format json
      register: group_list
      changed_when: false

    - name: Determine if group exists
      ansible.builtin.set_fact:
        group_exists: >-
          {{
            (group_list.stdout | from_json
            | selectattr('groupid', 'equalto', pve_group)
            | list
            | length) > 0
          }}

    - name: Create group if missing
      ansible.builtin.command: pveum group add {{ pve_group }}
      when: not group_exists

    - name: Check ACL list
      ansible.builtin.command: pveum acl list --output-format json
      register: acl_list
      changed_when: false

    - name: Determine if ACL exists
      ansible.builtin.set_fact:
        acl_exists: >-
          {{
            (acl_list.stdout | from_json
            | selectattr('path', 'equalto', '/')
            | selectattr('type', 'equalto', 'group')
            | selectattr('ugid', 'equalto', pve_group)
            | selectattr('roleid', 'equalto', pve_role)
            | list
            | length) > 0
          }}

    - name: Ensure ACL set for group at /
      ansible.builtin.command: pveum acl modify / -group {{ pve_group }} -role {{ pve_role }}
      when: not acl_exists

    - name: Check existing users
      ansible.builtin.command: pveum user list --output-format json
      register: user_list
      changed_when: false

    - name: Determine if user exists
      ansible.builtin.set_fact:
        user_exists: >-
          {{
            (user_list.stdout | from_json
            | selectattr('userid', 'equalto', pve_user)
            | list
            | length) > 0
          }}

    - name: Create user if missing
      ansible.builtin.command: pveum useradd {{ pve_user }} -groups {{ pve_group }}
      when: not user_exists

    - name: Ensure user is in group (if user existed)
      ansible.builtin.command: pveum user modify {{ pve_user }} -groups {{ pve_group }}
      when: user_exists
      changed_when: false

    # --- Token: create if missing, store locally if created ---
    - name: List existing tokens for user
      ansible.builtin.command: pveum user token list {{ pve_user }} --output-format json
      register: token_list
      changed_when: false
      failed_when: false

    - name: Default token_exists to false
      ansible.builtin.set_fact:
        token_exists: false

    - name: Determine if token exists
      ansible.builtin.set_fact:
        token_exists: >-
          {{
            (token_list.stdout | from_json
            | selectattr('tokenid', 'equalto', pve_token_name)
            | list
            | length) > 0
          }}
      when: token_list.rc == 0 and (token_list.stdout | trim) != ""

    - name: Create token if missing (secret printed once)
      ansible.builtin.command: pveum user token add {{ pve_user }} {{ pve_token_name }} -privsep {{ pve_token_privsep }} --output-format json
      register: token_create
      when: not token_exists

    - name: Ensure local secrets dir exists
      ansible.builtin.file:
        path: "{{ token_out_dir }}"
        state: directory
        mode: "0700"
      delegate_to: localhost
      run_once: true

    - name: Save token output locally (controller) if created
      ansible.builtin.copy:
        dest: "{{ token_out_dir }}/{{ token_out_file }}"
        content: "{{ token_create.stdout | trim }}\n"
        mode: "0600"
      delegate_to: localhost
      when: token_create is defined and token_create.changed

    - name: Report token status
      ansible.builtin.debug:
        msg: >-
          {{
            (token_create is defined and token_create.changed)
            | ternary(
                'Token CREATED and saved to ' ~ token_out_dir ~ '/' ~ token_out_file ~ '.',
                'Token already exists for ' ~ pve_user ~ '!' ~ pve_token_name ~ ' (secret cannot be re-shown). Rotate by deleting token then rerun.'
              )
          }}
